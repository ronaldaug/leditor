var flink = `<svg class="ticon" width="476pt" height="476pt"  data-com="link" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52.974 52.974"><path d="M49.467 3.51c-4.677-4.679-12.291-4.681-16.97 0l-9.192 9.192c-.391.391-.391 1.023 0 1.414s1.023.391 1.414 0l9.192-9.192c1.88-1.88 4.391-2.915 7.07-2.915 2.681 0 5.191 1.036 7.071 2.916s2.916 4.391 2.916 7.071c0 2.68-1.036 5.19-2.916 7.07L36.033 31.088c-3.898 3.898-10.244 3.898-14.143 0-.391-.391-1.023-.391-1.414 0s-.391 1.023 0 1.414c2.34 2.339 5.412 3.509 8.485 3.509s6.146-1.17 8.485-3.509L49.467 20.48c2.258-2.258 3.502-5.271 3.502-8.485 0-3.214-1.244-6.227-3.502-8.485z"/><path d="M26.84 40.279l-7.778 7.778c-1.88 1.88-4.391 2.916-7.071 2.916-2.68 0-5.19-1.036-7.071-2.916-3.898-3.898-3.898-10.243 0-14.142l11.314-11.314c3.899-3.898 10.244-3.896 14.142 0 .391.391 1.023.391 1.414 0s.391-1.023 0-1.414c-4.677-4.679-12.291-4.681-16.97 0L3.505 32.502C1.247 34.76.004 37.773.004 40.987c0 3.214 1.244 6.227 3.502 8.484s5.271 3.502 8.484 3.502c3.215 0 6.228-1.244 8.485-3.502l7.778-7.778c.391-.391.391-1.023 0-1.414s-1.022-.39-1.413 0z"/></svg>`;
var funlink = `<svg class="ticon" width="476pt" height="476pt"  data-com="unlink" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52.974 52.974"><path d="M49.467 3.51c-4.677-4.679-12.291-4.681-16.97 0l-9.192 9.192c-.391.391-.391 1.023 0 1.414s1.023.391 1.414 0l9.192-9.192c1.88-1.88 4.391-2.915 7.07-2.915 2.681 0 5.191 1.036 7.071 2.916s2.916 4.391 2.916 7.071c0 2.68-1.036 5.19-2.916 7.07L36.033 31.088c-3.898 3.898-10.244 3.898-14.143 0-.391-.391-1.023-.391-1.414 0s-.391 1.023 0 1.414c2.34 2.339 5.412 3.509 8.485 3.509s6.146-1.17 8.485-3.509L49.467 20.48c2.258-2.258 3.502-5.271 3.502-8.485 0-3.214-1.244-6.227-3.502-8.485z"/><path d="M26.84 40.279l-7.778 7.778c-1.88 1.88-4.391 2.916-7.071 2.916-2.68 0-5.19-1.036-7.071-2.916-3.898-3.898-3.898-10.243 0-14.142l11.314-11.314c3.899-3.898 10.244-3.896 14.142 0 .391.391 1.023.391 1.414 0s.391-1.023 0-1.414c-4.677-4.679-12.291-4.681-16.97 0L3.505 32.502C1.247 34.76.004 37.773.004 40.987c0 3.214 1.244 6.227 3.502 8.484s5.271 3.502 8.484 3.502c3.215 0 6.228-1.244 8.485-3.502l7.778-7.778c.391-.391.391-1.023 0-1.414s-1.022-.39-1.413 0zM33.969 44.009c-.553 0-1 .447-1 1v6c0 .553.447 1 1 1s1-.447 1-1v-6c0-.553-.447-1-1-1zM38.433 42.302c-.391-.391-1.023-.391-1.414 0s-.391 1.023 0 1.414l4.243 4.242c.195.195.451.293.707.293s.512-.098.707-.293c.391-.391.391-1.023 0-1.414l-4.243-4.242zM44.969 38.009h-6c-.553 0-1 .447-1 1s.447 1 1 1h6c.553 0 1-.447 1-1s-.447-1-1-1zM15.969 11.009c.553 0 1-.447 1-1v-6c0-.553-.447-1-1-1s-1 .447-1 1v6c0 .553.448 1 1 1zM11.504 12.716c.195.195.451.293.707.293s.512-.098.707-.293c.391-.391.391-1.023 0-1.414L8.676 7.06c-.391-.391-1.023-.391-1.414 0s-.391 1.023 0 1.414l4.242 4.242zM4.969 17.009h6c.553 0 1-.447 1-1s-.447-1-1-1h-6c-.553 0-1 .447-1 1s.448 1 1 1z"/></svg>`;
var fpencil = `<svg class="ticon" width="476pt" height="476pt"  data-com="edit" viewBox="0 0 476.76426 476" xmlns="http://www.w3.org/2000/svg"><path d="M451.023438 26.117188c-34.386719-34.3125-90.058594-34.3125-124.449219 0v.046874L40.992188 311.714844c-.648438.683594-1.171876 1.472656-1.542969 2.335937-.101563.214844-.195313.433594-.273438.65625-.097656.21875-.1875.4375-.261719.664063L.257812 467.132812c-.714843 2.742188.082032 5.660157 2.085938 7.664063s4.921875 2.796875 7.664062 2.085937l151.753907-38.640624c.230469-.0625.429687-.183594.65625-.261719.230469-.078125.457031-.171875.679687-.273438.859375-.371093 1.648438-.894531 2.328125-1.542969L450.96875 150.605469l.054688-.042969c34.320312-34.382812 34.320312-90.0625 0-124.445312zm-11.3125 11.308593c25.886718 25.949219 28.1875 67.183594 5.351562 95.851563L343.871094 32.074219c28.664062-22.835938 69.898437-20.53125 95.839844 5.351562zm-107.472657 5.707031l101.808594 101.757813-28.679687 28.6875L303.558594 71.773438zM28.792969 419.933594c12.628906 5.671875 22.742187 15.78125 28.414062 28.414062l-38.117187 9.703125zm44 24.421875c-7.367188-18.199219-21.800781-32.632813-40-40L50.9375 332.972656l93.230469 93.238282zm86.976562-25.199219L57.960938 317.371094 292.25 83.082031l101.804688 101.808594zm0 0"/></svg>`;
var fquote = `<svg class="ticon" width="476pt" height="476pt"  data-com="blockquote" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M50.6292648 26.225668c-.1288986-1.3934994-.0303001-5.1816006 3.5985985-10.4492006.2745018-.3975.2247009-.9335995-.1161957-1.2743998-1.4795036-1.4794998-2.395504-2.4131002-3.0379982-3.0663996-.8448029-.8614006-1.2305031-1.2539005-1.795002-1.7657003-.3769035-.3388004-.9472008-.3446999-1.3281021-.0125999-6.3251991 5.5038996-13.3505974 16.8768997-12.3339958 30.8105011.5956955 8.1815987 6.5634956 14.1200981 14.1894951 14.1200981 7.8260994 0 14.1932983-6.3661995 14.1932983-14.1923981 0-7.5498009-5.9256935-13.7412015-13.3700981-14.1699009zm-.8232002 26.3622989c-6.5489006 0-11.6767998-5.1581993-12.1953011-12.2645988v-.0009995c-1.1435966-15.6709003 8.1718025-25.8496017 10.9863014-28.5449009.2743988.2705002.5878983.5887995 1.0498009 1.0594997.5565987.5664005 1.3183975 1.3417997 2.4706993 2.4981003-4.4053001 6.7870998-3.5741997 11.6229992-3.2099991 12.3164005.1728973.3290997.5273972.5508003.8984985.5508003 6.7236023 0 12.1932983 5.469698 12.1932983 12.1933002 1e-7 6.7226984-5.4696959 12.1923982-12.1932982 12.1923982zM15.1136675 26.225668c-.1299-1.3896008-.0341997-5.1748009 3.5985994-10.4492006.2735004-.3975.2245998-.9335995-.1161995-1.2743998-1.4766006-1.4765997-2.3915997-2.4091997-3.0332003-3.0625-.8476-.8633003-1.2343998-1.2568998-1.7987995-1.7695999-.3769999-.3388004-.9473-.3437004-1.3281002-.0136003-6.3251996 5.5039005-13.3515997 16.875-12.3369999 30.8115005v.0009995c.5977 8.1805992 6.5664001 14.1190987 14.1924 14.1190987 7.8261995 0 14.1934004-6.3661995 14.1934004-14.1923981 0-7.5507003-5.9258003-13.7431003-13.3711004-14.1699zm-.8223 26.3622989c-6.5478001 0-11.6786995-5.1581993-12.1982002-12.2655983v.0009995c-1.1406-15.6748009 8.1747999-25.8516006 10.9892006-28.5459003.2754002.2705002.5899.5908003 1.0528002 1.0625.5555992.5663996 1.3163996 1.3408003 2.4667988 2.4951-4.4052992 6.7880993-3.5741997 11.6229992-3.2099991 12.3153992.1729002.3291016.5283003.5518017.8993998.5518017 6.7237005 0 12.1934004 5.469698 12.1934004 12.1933002-1e-7 6.7226982-5.4696999 12.192398-12.1934005 12.192398z"/></svg>`;
var fleft = `<svg class="ticon" width="476pt" height="476pt"  data-com="justifyLeft" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22.916 22.916"><path d="M11.458 22.828H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h10.958c.276 0 .5.224.5.5s-.224.5-.5.5zM22.416 15.582H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.916c.276 0 .5.224.5.5s-.224.5-.5.5zM22.416 8.335H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.916c.276 0 .5.224.5.5s-.224.5-.5.5zM22.416 1.088H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.916c.276 0 .5.224.5.5s-.224.5-.5.5z"/></svg>`;
var fcenter = `<svg class="ticon" width="476pt" height="476pt"  data-com="justifyCenter" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22.914 22.914"><path d="M17.719 22.827H5.195c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h12.523c.276 0 .5.224.5.5s-.223.5-.499.5zM22.414 15.581H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.914c.276 0 .5.224.5.5s-.224.5-.5.5zM17.719 8.334H5.195c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h12.523c.276 0 .5.224.5.5s-.223.5-.499.5zM22.414 1.087H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.914c.276 0 .5.224.5.5s-.224.5-.5.5z"/></svg>`;
var fright = `<svg class="ticon" width="476pt" height="476pt"  data-com="justifyRight" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22.916 22.916"><path d="M22.059 22.828H11.101c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h10.958c.276 0 .5.224.5.5s-.224.5-.5.5zM22.416 15.582H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.916c.276 0 .5.224.5.5s-.224.5-.5.5zM22.416 8.335H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.916c.276 0 .5.224.5.5s-.224.5-.5.5zM22.416 1.088H.5c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h21.916c.276 0 .5.224.5.5s-.224.5-.5.5z"/></svg>`;
var fhighlight = `<svg class="ticon" width="476pt" height="476pt"  data-com="color" xmlns="http://www.w3.org/2000/svg"><path d="M2.739 19.962a.3.3 0 0 0 .213-.087 3.386 3.386 0 0 1 2.426-.9c.348 0 .695.036 1.035.108a.9.9 0 0 0 1.2-.063l.423-.426 9.733-11.247a.9.9 0 0 0-.063-1.2l-2.799-2.852a.9.9 0 0 0-1.226-.045L2.54 13.073l-.44.438a.9.9 0 0 0-.262.635.9.9 0 0 0 .201.582c.081.37.426 2.25-.786 3.462a.3.3 0 0 0-.054.318L.088 19.614a.3.3 0 0 0 .078.48l1.2.6a.3.3 0 0 0 .134.033h9.598a.3.3 0 1 0 0-.6H2.355l.249-.2a.301.301 0 0 0 .135.035zm11.334-16.26a.3.3 0 0 1 .408.019l2.826 2.825a.3.3 0 0 1 .024.402L7.799 17.947l-4.622-4.634 10.896-9.61zM1.461 20.074l-.654-.327.795-.798.561.561-.702.564zm.471-1.644l-.05-.05c1.33-1.581.749-3.789.722-3.885v.006a.3.3 0 0 0-.075-.129.3.3 0 0 1-.09-.216.3.3 0 0 1 .087-.213l.21-.212 4.67 4.657-.213.213a.3.3 0 0 1-.424.002l-.002-.002a.3.3 0 0 0-.135-.078 5.256 5.256 0 0 0-1.257-.144 4.016 4.016 0 0 0-2.63.87l-.813-.819z" fill="#000" fill-rule="evenodd"/></svg>`;

var fsave = `<svg class="imgicon" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="#000" fill-rule="evenodd"><path d="M14.6622857 0H.1836735v18H17.8163265V3.1540408L14.6622857 0zm-1.6214694.7346939V5.877551H4.2244898V.734694h8.8163265zM3.4897959 17.265306v-6.9795918h10.6530612v6.9795918H3.4897959zm13.5918368 0H14.877551V9.5510204H2.755102v7.7142857H.9183673V.7346939H3.489796v5.877551h10.2857143V.7346939h.5826122l2.7235103 2.7235102v13.807102z"/><path d="M4.9591837 12.122449h2.5714285c.2031429 0 .367347-.1642041.367347-.367347 0-.2031428-.1642041-.3673469-.367347-.3673469H4.9591837c-.2031429 0-.367347.1642041-.367347.3673469 0 .2031429.1642041.367347.367347.367347zM8.632653 12.8571429H4.9591838c-.2031429 0-.367347.164204-.367347.3673469s.1642041.3673469.367347.3673469H8.632653c.2031428 0 .3673469-.164204.3673469-.3673469s-.164204-.3673469-.367347-.3673469zM9.4738775 12.9636735c-.0664897.0694285-.1065306.1653061-.1065306.2608163 0 .0955102.0400409.1910204.1065306.2608163.0694286.0661225.1612654.1065306.2608164.1065306.0955102 0 .1910204-.0404081.2608163-.1065306.0661225-.0697959.1065306-.1653061.1065306-.2608163 0-.0955102-.0404081-.1913878-.1065306-.2608163-.1359184-.1359184-.3857143-.1359184-.5216327 0zM12.3061224 1.4693878h-2.2040816V5.142857h2.2040816V1.4693878zm-.7346938 2.9387755h-.7346939V2.2040816h.7346939v2.2040817z"/></g></svg>`;
var ftrash = `<svg class="imgicon" width="476pt" height="476pt" data-col="trash" xmlns="http://www.w3.org/2000/svg"><path d="M17.96056.55976L17.40168 0l-8.4212 8.42064L.55984 0 .0004.55976l8.42064 8.42056L.0004 17.40096l.55944.56L8.98048 9.5392l8.4212 8.42176.55888-.56-8.42064-8.42064z" fill-rule="evenodd"/></svg>`;
var flefti = `<svg class="imgicon" width="476pt" height="476pt" data-col="two" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M501.333 213.333h-192c-5.896 0-10.667 4.771-10.667 10.667s4.771 10.667 10.667 10.667h192c5.896 0 10.667-4.771 10.667-10.667s-4.771-10.667-10.667-10.667zM501.333 320H10.667C4.771 320 0 324.771 0 330.667s4.771 10.667 10.667 10.667h490.667c5.896 0 10.667-4.771 10.667-10.667C512 324.771 507.229 320 501.333 320zM330.667 426.667h-320C4.771 426.667 0 431.438 0 437.333 0 443.229 4.771 448 10.667 448h320c5.896 0 10.667-4.771 10.667-10.667-.001-5.895-4.771-10.666-10.667-10.666zM309.333 128h192c5.896 0 10.667-4.771 10.667-10.667s-4.771-10.667-10.667-10.667h-192c-5.896 0-10.667 4.771-10.667 10.667.001 5.896 4.772 10.667 10.667 10.667zM10.667 256h234.667c5.896 0 10.667-4.771 10.667-10.667V74.667C256 68.771 251.229 64 245.333 64H10.667C4.771 64 0 68.771 0 74.667v170.667C0 251.229 4.771 256 10.667 256zm224-21.333H25.75l48.917-48.917 35.125 35.125c4.167 4.167 10.917 4.167 15.083 0s4.167-10.917 0-15.083l-3.125-3.125 48.917-48.917 64 64v16.917zM21.333 85.333h213.333v102.25l-56.458-56.458c-4.167-4.167-10.917-4.167-15.083 0l-56.458 56.458-24.458-24.458c-4.167-4.167-10.917-4.167-15.083 0l-45.792 45.792V85.333z"/><path d="M106.667 149.333c11.76 0 21.333-9.573 21.333-21.333s-9.573-21.333-21.333-21.333c-11.76 0-21.333 9.573-21.333 21.333s9.572 21.333 21.333 21.333zM117.333 128h-10.656s-.01-.01-.01-.021l10.666.021z"/></svg>`;
var fcenteri = `<svg class="imgicon"width="476pt" height="476pt" data-col="one"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M501.333 213.333h-64c-5.896 0-10.667 4.771-10.667 10.667s4.771 10.667 10.667 10.667h64c5.896 0 10.667-4.771 10.667-10.667s-4.771-10.667-10.667-10.667zM501.333 320H10.667C4.771 320 0 324.771 0 330.667s4.771 10.667 10.667 10.667h490.667c5.896 0 10.667-4.771 10.667-10.667C512 324.771 507.229 320 501.333 320zM330.667 426.667h-320C4.771 426.667 0 431.438 0 437.333 0 443.229 4.771 448 10.667 448h320c5.896 0 10.667-4.771 10.667-10.667-.001-5.895-4.771-10.666-10.667-10.666zM437.333 128h64c5.896 0 10.667-4.771 10.667-10.667s-4.771-10.667-10.667-10.667h-64c-5.896 0-10.667 4.771-10.667 10.667.001 5.896 4.772 10.667 10.667 10.667zM12.354 234.667h64c5.896 0 10.667-4.771 10.667-10.667s-4.771-10.667-10.667-10.667h-64c-5.896 0-10.667 4.771-10.667 10.667s4.771 10.667 10.667 10.667zM12.354 128h64c5.896 0 10.667-4.771 10.667-10.667s-4.771-10.667-10.667-10.667h-64c-5.896 0-10.667 4.771-10.667 10.667C1.688 123.229 6.458 128 12.354 128zM138.667 256h234.667c5.896 0 10.667-4.771 10.667-10.667V74.667C384 68.771 379.229 64 373.333 64H138.667C132.771 64 128 68.771 128 74.667v170.667c0 5.895 4.771 10.666 10.667 10.666zm224-21.333H153.741l48.926-48.917 35.125 35.125c4.167 4.167 10.917 4.167 15.083 0s4.167-10.917 0-15.083l-3.125-3.125 48.917-48.917 64 64v16.917zM149.333 85.333h213.333v102.25l-56.458-56.458c-4.167-4.167-10.917-4.167-15.083 0l-56.458 56.458-24.458-24.458c-4.167-4.167-10.917-4.167-15.083 0l-45.792 45.784V85.333z"/><path d="M234.667 149.333C246.438 149.333 256 139.76 256 128s-9.563-21.333-21.333-21.333c-11.771 0-21.333 9.573-21.333 21.333s9.562 21.333 21.333 21.333zm0-21.354l10.666.021h-10.667c.001 0 .001-.01.001-.021z"/></svg>`;
var fimage = `<svg class="imgicon" width="476pt" height="476pt" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><path d="M14 24.138c3.071 0 5.569-2.498 5.569-5.568 0-3.072-2.498-5.57-5.569-5.57s-5.569 2.498-5.569 5.569c0 3.071 2.498 5.569 5.569 5.569zM14 15c1.968 0 3.569 1.602 3.569 3.569S15.968 22.138 14 22.138s-3.569-1.601-3.569-3.568S12.032 15 14 15z"/><path d="M1 0v52h50V0H1zm2 2h46v26.727l-10.324-9.464c-.196-.179-.454-.268-.72-.262-.265.012-.515.129-.694.325l-9.794 10.727-4.743-4.743c-.374-.373-.972-.392-1.368-.044L4.622 40H3V2zm46 48H3v-8h46v8zM7.649 40l14.324-12.611L32.275 37.69c.391.391 1.023.391 1.414 0s.391-1.023 0-1.414l-4.807-4.807 9.181-10.054L49 31.44V40H7.649z"/></svg>`;
var toolT = `<div class="tool-wrap"><button data-com="bold">B</button><button data-com="italic">I</button><button data-com="link">${flink}</button><button data-com="unlink">${funlink}</button><button data-com="h1">T</button><button data-com="p"><small data-com="p">T</small></button><button data-com="blockquote">${fquote}</button><button data-com="color">${fhighlight}</button><button data-com="justifyLeft">${fleft}</button><button data-com="justifyCenter">${fcenter}</button><button data-com="justifyRight">${fright}</button><button data-com="edit">${fpencil}</button></div>`;
var htmlEditor = `<div class="html-editor-wrap"><span class="save-html">+</span><br /><br /><div contenteditable="true" class="html-editor"></div></div>`;
var currentEditor = '';
let Leditor = document.querySelector("#l-editor");
var isEdit = false;

// Checking browser
var isBrowser = (name)=>{
  return navigator.userAgent.indexOf(name.charAt(0).toUpperCase() + name.slice(1)) != -1; 
}

// Check in Localstrage
var render = () =>{
  // if the browser is safari
  if(isBrowser('safari') && !isBrowser('chrome')){
    return;
  }
  let stored = localStorage.getItem('light-editor');
  if(!stored){return}
  Leditor.innerHTML = JSON.parse(stored);
}
render();

var getUid = function () {
  return Math.random().toString(36).substr(2, 9);
  };

// Listen click event of tooltip buttons (call from body to be sure)
document.body.addEventListener("click",e=>{

  let closeLE =  e.target.closest('.leditor');
  if(closeLE){
     newE = closeLE;
      var uniqueId = closeLE.dataset.uid;
      var LE = document.querySelector(`div[data-uid="${uniqueId}"]`);
      let allE = document.querySelectorAll(".leditor");
      allE.forEach(x=>{
            if(uniqueId == x.dataset.uid){return}
                x.classList.remove('active-edit');
                x.removeAttribute("contenteditable")
                removeEditIcon();
      });
  }


    // Listen Svae button
    if(e.target.tagName == "SPAN" && e.target.className == 'plus-icon'){
      let editorToClone = document.querySelector("div.active-edit");
      let newCopy = editorToClone.cloneNode(true);
      let editI = newCopy.querySelector('div.edit-wrap');
      let cleb = newCopy.querySelector('div.clear-b');
      if(editI){editI.remove()}
      if(cleb){cleb.remove()}
      newCopy.setAttribute('data-uid',getUid());
      editorToClone.parentNode.insertBefore(newCopy,editorToClone.nextSibling);
}


  if(e.detail == 2){
    isEdit = true;
    currentEditor = LE;
    if(!LE){return}
    LE.setAttribute('contenteditable','true');
    LE.classList.add('active-edit');
    LE.focus();
    // create save icon
    let saveIcon = document.createElement('span');
    saveIcon.className = 'save-icon';
    saveIcon.setAttribute('contenteditable','false');
    saveIcon.innerHTML = fsave;

        // create save icon
        let deletIcon = document.createElement('span');
        deletIcon.className = 'delete-icon';
        deletIcon.setAttribute('contenteditable','false');
        deletIcon.innerHTML = ftrash;

    // create plus icon
    let plusIcon = document.createElement('span');
    plusIcon.className = 'plus-icon';
    plusIcon.setAttribute('contenteditable','false');
    plusIcon.innerHTML = '+';

    // trick for auto height;
    let clearB = document.createElement('div');
    clearB.className = "clear-b";
    clearB.setAttribute("style","clear:both");

   let editWrap = document.createElement('div');
   editWrap.className = 'edit-wrap';
   editWrap.innerHTML = plusIcon.outerHTML + saveIcon.outerHTML + deletIcon.outerHTML;
   let checkExit = LE.querySelector('.edit-wrap');
   let checkClearb = LE.querySelector('.clear-b');
   if(!checkExit){
    LE.appendChild(editWrap);
   }
   if(!checkClearb){
      once(LE.appendChild(clearB))
   }

    // Remove tooltip icons on click
LE.addEventListener('click',(e)=>{
  if(!isEdit){return}
  removeTool();
  checkClickImage(e,LE);
 var sel = window.getSelection();
 if(sel.toString()){
   appendTool();
   return;
 }
 if(e.detail == 2){
   appendTool();
 }
})

            // Listen everytime user hit backspace and enter
LE.addEventListener('keydown',e=>{
  if(LE.innerHTML == 0){
    LE.innerHTML = '<p>&nbsp;</p>'
  }
  if(e.keyCode == 8){
   removeCircle();
  removeAllhidden();
  }
  if(e.keyCode == 13){
   removeCircle();
   pasteHtmlAtCaret('<span class="hidden-place" style="opacity:0;visibility:hidden"></span>');
   let {x,y} = getCursorPos();
     const btnWrap = document.createElement('div');
     btnWrap.className = 'btn-wrap';
     btnWrap.innerHTML = `<button class="lbtn circle-btn">+</button>`;
     let yPos = y + 32;
     btnWrap.setAttribute('style', `position:fixed; top:${yPos}px; left:80px;`)
   document.body.append(btnWrap);
   listenClickPlusIcon(yPos);
   }
})

listenClicks(LE);
  


   } // detail 2

   let currentE = document.querySelector("div.active-edit");
   let toolW = document.querySelector("div.tool-wrap");
   if(currentE){
   var isClickInside = currentE.contains(e.target);
         if (isClickInside) {
           return;
         }
         if(!toolW){return}
         if(!toolW.contains(e.target)){
               removeTool();
         }
 }

   var Sel = window.getSelection();
  var command = e.target.dataset.com;
   if(!command){return}
    if (command == 'h1' || command == 'blockquote' || command == 'p') {
      document.execCommand('formatBlock', false, command);
      return;
    }else if(command == 'link' || command == "color"){
      removeTool();
      if(!Sel.toString()){
         Msg('error','Please select text!',2000)
         return;
      }
      let linput = `<input placeholder="http://..." name="link-url" class="ele-val">`;
      let cinput = `<input type="color" name="text-color" value="#09d6bb" class="ele-val">`;
    let pModal = `<div class="img-form" style="animation:bounceIn linear 0.4s"><span class="close-icon">+</span><br />${command == 'link'?linput:cinput}<button class="add-btn">Add</button></div>`;
      createModal(pModal);
          document.execCommand('createLink',false,'http://');
          Sel.anchorNode.parentElement.className = "temp-ele";

              var addBtn = document.querySelector('.add-btn');
              addBtn.addEventListener('click',(e)=>{
                let thisEle = document.querySelector('.temp-ele');
                let EleVal = document.querySelector('.ele-val').value;
                if(!EleVal){
                    Msg('error','Please add url', 2000);
                    return;
                }
                if(command == 'link'){
                    thisEle.href = EleVal;
                    thisEle.target = '_blank';
                }else{
                   let dom = document.createElement("span");
                   dom.style.color = EleVal;
                   dom.innerHTML = thisEle.innerHTML;
                   thisEle.outerHTML = dom.outerHTML;
                }
                thisEle.removeAttribute("class");
                removeModal();
              })


      closeModal();


    }else if(command == 'edit'){
      removeCircle();
      removeAllhidden();
      removeTool();
     currentEditor = document.querySelector('div.active-edit');
      if(currentEditor){
          var saveData = currentEditor;
          let edits = saveData.querySelector('div.edit-wrap')
          let clearb = saveData.querySelector('div.clear-b')
          let fDrag = saveData.querySelectorAll("span.f-drag");
          let saveFD = fDrag[0].outerHTML;
          if(edits){
            edits.remove();
          }
          if(clearb){
            clearb.remove();
          }
          if(fDrag){
            fDrag.forEach(e=>e.remove());
          }
          createModal(htmlEditor);
          let htmlE = document.querySelector('.html-editor');
          htmlE.textContent = saveData.innerHTML;
          listenSaveHTML(htmlE,currentEditor,fDrag,saveFD);
      }
    }else{
          document.execCommand(command, false, null);
    }
})


// Append tooltip
var appendTool = ()=>{
  removeTool();
  var T = document.createElement('div');
  T.className = 'tooltip';
  T.innerHTML = toolT;
  document.body.append(T);
  var {x,y,cor} = getCursorPos(T);
  if(cor){
    T.childNodes[0].classList.add('trangle-up');
  }
  T.setAttribute('style',`animation:bounceIn 0.5s;top:${y}px;left:${x}px`)
}

// if tooltip exist remove it
var removeTool = ()=>{
  let imgT = document.querySelector('.img-tool');
  if(imgT){imgT.remove()};
  let reT = document.querySelector('.tooltip');
  if(reT){reT.remove()}
}

// Get text width
var getW = ()=>{
    var sel = document.selection, range;
    var width = 0;
    if (sel) {
        if (sel.type != "Control") {
            range = sel.createRange();
            width = range.boundingWidth;
        }
    } else if (window.getSelection) {
        sel = window.getSelection();
        if (sel.rangeCount) {
            range = sel.getRangeAt(0).cloneRange();
            if (range.getBoundingClientRect) {
                var rect = range.getBoundingClientRect();
                width = rect.right - rect.left;
            }
        }
    }
    return width;
}



const listenClicks = (LE)=>{
  let deletClick = LE.querySelector('span.delete-icon');
deletClick.addEventListener('click',e=>{
  e.target.closest(".leditor").remove();
})

let saveClick = LE.querySelector('span.save-icon');
saveClick.addEventListener('click',e=>{
        isEdit = false;
        removeEditIcon();
        removeAllhidden();
        removeCircle();
        removeTool();
        removeTempImg(LE);
        setTimeout(()=>{
          saveMe();
        },300)
        LE.removeAttribute('contenteditable');
    })
} // listenClicks End

// Remove Popup Modal
const removeModal = () =>{
  let MD = document.querySelector('.popup-modal');
  if(MD){MD.remove()}
}


const closeModal = () =>{
      let closeIcon =  document.querySelector('.close-icon');
      closeIcon.addEventListener('click',e=>{
           let thisEle = document.querySelector('.temp-ele');
          thisEle.outerHTML = thisEle.innerHTML;
           removeModal();
      });
}



// Remove circle tooltips group which appears when enter
const removeCircle = () =>{
  let floatBtn = document.querySelectorAll('.btn-wrap');
  let cbBtn = document.querySelectorAll('div.btn-float');
  removeModal();
  if(floatBtn){floatBtn.forEach(e=>e.remove())};
  if(cbBtn){cbBtn.forEach(c=>c.remove())};
}

// Get cursor position
// https://stackoverflow.com/questions/41140118/how-to-split-contenteditable-contents-based-on-the-caret-position/41142439
var getCursorPos = (T)=>{
  var sel = document.selection, range, rect;
  var x = 0, y = 0;
  if (sel) {
      if (sel.type != "Control") {
          range = sel.createRange();
          range.collapse(true);
          x = range.boundingLeft;
          y = range.boundingTop;
      }
  } else if (window.getSelection) {
      sel = window.getSelection();
      if (sel.rangeCount) {
          range = sel.getRangeAt(0).cloneRange();
          if (range.getClientRects) {
              range.collapse(true);
              if (range.getClientRects().length>0){
                  rect = range.getClientRects()[0];
                  x = rect.left;
                  y = rect.top;
              }
          }
          // Fall back to inserting a temporary element
          if (x == 0 && y == 0) {
              var span = document.createElement("span");
              if (span.getClientRects) {
                  // Ensure span has dimensions and position by
                  // adding a zero-width space character
                  span.appendChild( document.createTextNode("\u200b") );
                  range.insertNode(span);
                  rect = span.getClientRects()[0];
                  x = rect.left;
                  y = rect.top;
                  var spanParent = span.parentNode;
                  spanParent.removeChild(span);

                  // Glue any broken text nodes back together
                  spanParent.normalize();
              }
          }
      }
  }
  if(T){
    // make center
            var cor = false;
            var orX = x;
            var txtWidth = getW();
            var toolWidth = T.offsetWidth;
              if(sel.toString()){
                var half = x + (txtWidth/2);
                var x = half - (toolWidth/2);
              }else{
                var x = x - (toolWidth/2);
              }
            
              // if Y position to close to conor;
              if((y-50)<0){
                var y = y + 44;
                cor = true;
              }else{
                var y = y - 60;
              }
              // if x position to close to conor;
          if(0>orX-180){
              var x = orX>120?orX - 130:orX-100;
          }
   }
    return { x,y,cor}; 
}

// When user click plus sign circle button 
const listenClickPlusIcon = (yPos)=>{
  let CBtn = document.querySelector('button.circle-btn');
  if(CBtn){
    CBtn.addEventListener('click',(e)=>{
      let floatB = document.querySelector('div.btn-float');
      if(floatB){
         CBtn.setAttribute('style','transform:rotate(0);');
         setTimeout(()=>{
          floatB.remove();
          CBtn.remove();
         },300)
         return;
      }
     CBtn.setAttribute('style','transform:rotate(90deg);');
      const FB  = document.createElement('div');
      FB.className = 'btn-float';
      FB.innerHTML = `<button class="lbtn img-btn" style="animation:bounceIn linear 0.3s;">${fimage}</button><button style="animation:bounceIn linear 0.4s;" class="lbtn linebreak-btn">.</button>`;
      FB.setAttribute('style', `top:${yPos}px;left:120px;opacity:1;visibility:visible;width:auto;height:auto;`);
      document.body.append(FB);
      listenClickImageIcon();
      listenThreeDots();
  })
}
}

// When user click image icon
const listenClickImageIcon = () =>{
  let imgBtn = document.querySelector('button.img-btn');
  if(imgBtn){
    imgBtn.addEventListener('click', e =>{
        let imgF = `<div class="img-form" style="animation:bounceIn linear 0.4s"><span class="close-btn">+</span><br /><input placeholder="Image Url ..." name="img-url" class="img-url"><button class="add-img">Add</button></div>`;
        createModal(imgF);
        listenCloseBtn();
        listenAddImg();
        removeTool();
      })
  }
}

const listenThreeDots = () =>{
  let Lbtn = document.querySelector('button.linebreak-btn');
  if(Lbtn){
    Lbtn.addEventListener('click',e=>{
      let hiddenPlace = document.querySelector('.hidden-place');
      let threeDots  =  `<p class="three-dots" contenteditable="false"> . . . </p>`;
      hiddenPlace.outerHTML = threeDots;
    })
  }
}

// When user close image form
const listenCloseBtn = () =>{
   let CB = document.querySelector('span.close-btn');
   if(CB){
     CB.addEventListener('click', e=>{
         removeCircle();
         removeAllhidden();
     })
   }
}
// listen save HTML codes in code editor
const listenSaveHTML = (htmlE,currentEditor,fDrag,saveFD) =>{
  let SH = document.querySelector('span.save-html');
  if(SH){
    SH.addEventListener('click', e=>{
      let editedHTML = htmlE.textContent;
      if(fDrag){
        currentEditor.innerHTML = editedHTML + saveFD;
      }else{
        currentEditor.innerHTML =  editedHTML;
      }
      removeModal();
    })
  }
}

// When user click on add image button inside Image form
const listenAddImg = () =>{
  let addImg = document.querySelector('button.add-img');
  let imgInput = document.querySelector('input.img-url');
  if(addImg){
    addImg.addEventListener('click', e=>{
      let img = imgInput.value;
      if(!img){
        return;
      }
      let hiddenPlace = document.querySelector('.hidden-place');
      let imgW  =  `<img src="${img}">`;
      hiddenPlace.outerHTML = '<p>'+imgW+'</p>';
      removeCircle();
      removeAllhidden();
    })
  }
}

// Pase html at specific caret
// https://stackoverflow.com/questions/6690752/insert-html-at-caret-in-a-contenteditable-div
function pasteHtmlAtCaret(html) {
  var sel, range;
  if (window.getSelection) {
      // IE9 and non-IE
      sel = window.getSelection();
      if (sel.getRangeAt && sel.rangeCount) {
          range = sel.getRangeAt(0);
          range.deleteContents();

          // Range.createContextualFragment() would be useful here but is
          // non-standard and not supported in all browsers (IE9, for one)
          var el = document.createElement("div");
          el.innerHTML = html;
          var frag = document.createDocumentFragment(), node, lastNode;
          while ( (node = el.firstChild) ) {
              lastNode = frag.appendChild(node);
          }
          range.insertNode(frag);
          
          // Preserve the selection
          if (lastNode) {
              range = range.cloneRange();
              range.setStartAfter(lastNode);
              range.collapse(true);
              sel.removeAllRanges();
              sel.addRange(range);
          }
      }
  } else if (document.selection && document.selection.type != "Control") {
      // IE < 9
      document.selection.createRange().pasteHTML(html);
  }
}

// If all hidden span exit remove all
const removeAllhidden = ()=>{
  let rmHidden = document.querySelectorAll('.hidden-place');
  if(rmHidden){
      rmHidden.forEach(e=>{
        e.remove();
      })
  }
}

// When user click save
const saveMe = ()=>{
  removeEditIcon();
  if(isBrowser('safari') && !isBrowser('chrome')){
    Msg('error','Safari browser? Sorry, it has an issue with localStorage.',2000)
    return}
    let allE = document.querySelectorAll(".leditor");
    allE.forEach(e=>{
      if(e.hasAttribute("contenteditable")){
         e.removeAttribute("contenteditable");
      }
    })
    let activeEditors = Leditor.querySelectorAll(".active-edit");
    activeEditors.forEach(e=>{
       rmClass('active-edit',e);
    })

    let LEeditor = Leditor.cloneNode(true);
    let allDrag = LEeditor.querySelectorAll('span.f-drag');
    if(allDrag){allDrag.forEach(e=>e.remove())}

    localStorage.setItem('light-editor',JSON.stringify(LEeditor.innerHTML));
    // get Each Editor Data when it's need 
    // allE.forEach(editor=>{
    //   let lname = editor.dataset.uid;
    //   localStorage.setItem(lname,JSON.stringify(editor.innerHTML));
    // })
    Msg('success','Saved!',2000)

}

// Noti Msg
const Msg = (status,msg,time)=>{
  let ms = document.createElement('div');
  if(status == 'success'){
    ms.classList.add('success-msg');
  }else{
    ms.classList.add('error-msg');
  }
  ms.classList.add('noti-msg');
  ms.innerText = msg;
  document.body.append(ms);
  setTimeout(()=>{
    ms.remove();
  },time)
}


// Image editing goes here
var imgTool = document.createElement('div');
imgTool.classList.add('img-tool');
imgTool.setAttribute('contenteditable','false');
imgTool.innerHTML = `<span data-col="one">${fcenteri}</span><span data-col="two">${flefti}</span><span data-col="trash">${ftrash}</span>`;
var checkClickImage = (e,LE) =>{
  let Img = e.target;
  if( Img.tagName == 'IMG'){
        removeAllhidden();
        removeTempImg(LE);
        setTimeout(()=>{
        Img.classList.add("border-img");
        Img.parentNode.insertBefore(imgTool,Img);

        LE.addEventListener('click', once(e=>{
          let Col = e.target;
          if(Col.dataset.col == 'one'){
            let breakImage = document.createElement('p');
            breakImage.className = 'break-img';
            let checkBI = Img.previousSibling;
            if(checkBI){
              if(checkBI.tagName == 'IMG'){
                    if(!checkBI.hasAttribute('class')){
                      Img.parentNode.insertBefore(breakImage,Img)
                    }else{
                      if(checkBI.className == 'break-img'){return}else{
                        Img.parentNode.insertBefore(breakImage,Img)
                        }
                  }
                }
          }
           rmClass('two-col',Img);
           Img.classList.add('one-col');
         }else if(Col.dataset.col == 'two'){
          rmClass('one-col',Img);
          Img.classList.add('two-col');
        }else if(Col.dataset.col == 'trash'){
          Img.remove();
         }
        }))


      },50)
      return;
  }else{
    removeTempImg(LE);
  }
}

// Remove Image Class
const rmClass = (cl,el) =>{
  if(!el.classList.contains(cl)){return}
  el.classList.remove(cl);
}

// Remove Temp Image
function removeTempImg(LE){
  let imgs = LE.querySelectorAll('img');
      imgs.forEach(e=>{
        if(!e.hasAttribute("class")){return}
        if(e.className == 'border-img'){
            e.removeAttribute('class');
        }else{
            e.classList.remove("border-img")
        }
      })
}
  
// Create
const createModal = (content) =>{
  const MD = document.createElement('div');
  MD.className = 'popup-modal';
  MD.innerHTML = content;
  document.body.append(MD);
}

const removeEditIcon = ()=>{
  let allEdits = document.querySelectorAll('div.edit-wrap');
  if(allEdits){allEdits.forEach(e=>e.remove())}
}

// Run only one time
function once(fn, context) { 
	var result;
	return function() { 
		if(fn) {
			result = fn.apply(context || this, arguments);
			fn = null;
		}
		return result;
	};
}





  // Enable ShortCut Key Ctrl+S
//   var keyNum = '';
// document.body.addEventListener("keydown", (e)=>{
//   if(!isEdit){return}
//   if(isBrowser('firefox')){
//     if(e.keyCode == '83' || e.keyCode == '224'){
//       keyNum += e.keyCode;
//       if(keyNum == '22483'){
//         e.preventDefault(); // stop browser default Ctrl+S
//         saveMe();
//       }else if(keyNum.includes('22483')){
//         e.preventDefault(); // stop browser default Ctrl+S
//         saveMe();
//         keyNum = '';
//     }
//   }
//   }else{
//     if(e.keyCode == '83' || e.keyCode == '91'){
//       keyNum += e.keyCode;
//       if(keyNum == '9183'){
//         e.preventDefault(); // stop browser default Ctrl+S
//           saveMe();
//       }else if(keyNum.includes('9183')){
//         e.preventDefault(); // stop browser default Ctrl+S
//         saveMe();
//         keyNum = '';
//     }
//     }
//   }
// });
